# [浅谈iOS页面流畅技巧](https://mp.weixin.qq.com/s/Ov26MQmAFtVEJdpmC6nLcQ)

App 界面是用户第一接触的。如果界面卡顿，对用户影响很大，以后或许都不会再用此App。而不适当的编码，会导致用户界面卡顿。

界面卡顿的常见原因及界面方案。

1. cell绘制，离屏渲染导致
2. 主线程卡死，将下载、数据处理等比较耗时的操作放到子线程中，处理完成后回到主线程

## 1. 屏幕显示图像原理

CRT的电子枪，从上到下一行行扫描扫描完成后显示器就呈现一帧画面，随后电子枪回到初始位置继续下一次的扫描。当电子枪切换到新的一行准备扫描时，显示器会发送一个水平同步信号（Horizonal Synchronization），简称HSync；完成一帧画面绘制后，电子枪会回到原位，显示器会发送一个垂直同步信号（Vertical Synchronization），简称VSync。

CUP计算好显示内容提交到GPU，GPU渲染完成后将渲染结果放入帧缓冲区，之后视频控制器按照VSync 信号逐行读取帧缓冲区中的数据，最后经过各种数模转换传递给显示器显示。

## 2. 卡顿产生的原因

如果在一个 VSync 时间内，CPU 或者 GPU 没有完成内容提交，则那一帧就会被丢弃，等待下一次再显示，而这时显示屏会保留之前的内容不变，这就是卡顿的原因。

## 3. CPU 资源消耗的原因和解决方案

1. 对象的创建。对象的创建会分配内存、调整属性、甚至还有读取文件的操作，比较消耗CPU资源。
    * 尽量用轻量的对象代替重量的对象，如CALayer比UIView轻量的多，在不需要响应触摸事件时，用CALayer显示更合适
    * 如果对象不涉及 UI 操作，尽量放到后台线程去创建
    * 通过 storyboard 创建视图对象时，其资源消耗会比直接通过代码创建对象要大非常多，所以尽量避免使用
    * 尽量推迟对象创建的时间，并把对象的创建分散到多个任务中去
    * 如果对象可以复用，并且复用的代价比释放、创建新对象要小，那么这类对象应当尽量放到一个缓存池里复用
2. 对象调整。对象的调整也是经常消耗CPU资源的地方。尤其是CALayer。
    * CALayer 内部没有属性，通过 resolveInstanceMethod 实现，同时还会告知 delegate、创建动画等等，非常消耗资源。
    * UIView 关于显示相关的属性 （比如 frame/bouds/transform等）实际上都是CALayer 属性映射出来的，因此应该尽量减少类似的不必要的属性的修改。
    * 当视图层次调整时，UIView、CALayer 之间会出现很多调用与通知，所以在优化性能时，应该尽量避免调整视图层次、添加和移除视图。
3. 对象销毁。当容器类持有大量对象时，其销毁时的资源消耗就非常明显。所以，尽量去后台线程释放对象。
4. 对象布局。在后台线程提前计算好试图布局、并对视图的布局进行缓存。
5. Autolayout。随着视图数量的增长，Autolayout 带来的CPU消耗会呈指数级增长。最新版本已优化算法。
6. 文本计算。如果一个界面中包含大量的文本，文本的宽高计算会占用很大一部分资源，并且不可避免。
7. 文本渲染。显示大量文本时，CPU 的压力非常大，可以通过自定义文本控件，用TextKit 或最底层的 CoreText 对文本异步绘制，尽管麻烦但优势强大。
8. 图片解码
9. 图像的绘制

## 4. GPU 资源消耗的原因和解决方案

1. 纹理的渲染
2. 视图的混合
3. 图形的生成
